name: refresh-data

on:
  schedule:
    - cron: '*/30 00-02 * * *'
  push:
    branches:
      - master
      - main
      - upload-to-db
  pull_request:
    branches:
      - main
      - master

jobs:
  refresh-data:
    runs-on: macOS-latest
    env:
      R_CONFIG_ACTIVE: github
      GITHUB_PAT: ${{ secrets.MRJ_TOKEN }}
      PG_MASTER_USER: ${{ secrets.PG_MASTER_USER }}
      PG_MASTER_PW: ${{ secrets.PG_MASTER_PW }}
      PG_READ_OPEN_USER: ${{ secrets.PG_READ_OPEN_USER }}
      PG_READ_OPEN_PW: ${{ secrets.PG_READ_OPEN_PW }}
    steps:
      - uses: actions/checkout@v2
      - uses: r-lib/actions/setup-r@master
      - uses: r-lib/actions/setup-pandoc@v1

      - name: Get Github action IP
        id: ip
        uses: haythem/public-ip@v1.2

      - name: Remove Github Actions IP from security group
        run: |
          aws ec2 revoke-security-group-ingress --group-id ${{ env.AWS_SG_NAME }} --protocol tcp --port 5432 --cidr ${{ steps.ip.outputs.ipv4 }}/32
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ env.AWS_DEFAULT_REGION }}
        if: always()

      - name: Set AWS environment variables
        run: |
          echo "AWS_DEFAULT_REGION=ap-southeast-2" >> $GITHUB_ENV
          echo "AWS_SG_NAME=sg-0107d396b582171a1" >> $GITHUB_ENV
      - name: Add Github Actions IP to Security group
        run: |
          aws ec2 authorize-security-group-ingress --group-id ${{ env.AWS_SG_NAME }} --protocol tcp --port 5432 --cidr ${{ steps.ip.outputs.ipv4 }}/32
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ env.AWS_DEFAULT_REGION }}

      - name: Install packages
        run: Rscript -e 'install.packages(c("remotes", "pkgload", "rmarkdown", "usethis", "DBI", "dplyr", "lubridate", "config"), type = "binary")'
      - name: Install Db connection package
        run: Rscript -e 'remotes::install_github("djpr-data/djprConnect", auth_token = Sys.getenv("GITHUB_PAT"))'
      - name: Install dependencies
        run: Rscript -e 'remotes::install_deps(type = "binary", force = FALSE, dependencies = TRUE)'
      - name: Get data
        run: Rscript -e 'source(here::here("data-raw", "refresh_data.R"), echo = TRUE)'
      - name: Render README
        run: Rscript -e 'rmarkdown::render(here::here("README.Rmd"))'
      - name: Commit
        run: |
          git config --global user.name 'Matt Cowgill'
          git config --global user.email 'mattcowgill@github.com'
          git add .
          git commit -m 'refreshing data' || echo "No changes to commit"
          git push --force origin main || echo "No changes to commit"

      - name: Remove Github Actions IP from security group
        run: |
          aws ec2 revoke-security-group-ingress --group-id ${{ env.AWS_SG_NAME }} --protocol tcp --port 5432 --cidr ${{ steps.ip.outputs.ipv4 }}/32
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ env.AWS_DEFAULT_REGION }}
        if: always()
